<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bom para Voar - Drone Pulveriza√ß√£o</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Biblioteca para exportar Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <style>
    .search-container {
      position: relative;
      display: flex;
      width: 100%;
    }
    .search-button {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      padding: 0 12px;
      background: #3B82F6;
      color: white;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
    }
    .search-button:hover {
      background: #2563EB;
    }
    #citySuggestions {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 0 0 8px 8px;
      z-index: 10;
      display: none;
    }
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background-color: #f0f0f0;
    }
    .dark-mode body {
      background-color: #1a202c;
      color: #e2e8f0;
    }
    .dark-mode .bg-gray-100 {
      background-color: #2d3748;
    }
    .dark-mode .bg-gray-200 {
      background-color: #4a5568;
    }
    .dark-mode .text-gray-900 {
      color: #e2e8f0;
    }
    .dark-mode .bg-white {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    .dark-mode #citySuggestions {
      background-color: #2d3748;
      color: #e2e8f0;
      border-color: #4a5568;
    }
    .dark-mode .suggestion-item:hover {
      background-color: #4a5568;
    }
    .forecast-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .forecast-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .product-section {
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .dark-mode .product-section {
      background-color: #2d3748;
      border-color: #4a5568;
    }
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .remove-product {
      color: #ef4444;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .remove-product:hover {
      color: #dc2626;
    }
    .visitor-count {
      background-color: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 12px;
      font-size: 14px;
    }
    .dark-mode .visitor-count {
      background-color: #1e3a8a;
      border-color: #3b82f6;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-4xl mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Bom para Voar - Drone Pulveriza√ß√£o</h1>
      <div class="flex items-center">
        <div id="visitorCount" class="visitor-count hidden">
          <i class="fas fa-users"></i>
          <span id="visitorNumber">0</span> visitantes
        </div>
        <button 
          id="themeToggle" 
          class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"
          title="Alternar tema claro/escuro"
        >
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
        <button
          id="downloadReport"
          class="ml-2 px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2"
          title="Baixar relat√≥rio com os dados atuais"
        >
          <i class="fas fa-download"></i> Baixar Relat√≥rio
        </button>
      </div>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <div class="flex-1 relative">
        <input 
          type="text" 
          id="cityInput" 
          placeholder="Digite a cidade para pulverizar (ex: Bauru, SP)" 
          class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
          autocomplete="off"
        >
        <div id="citySuggestions" class="hidden"></div>
        <button 
          onclick="buscarPorCidade()" 
          class="absolute right-0 top-0 h-full px-3 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600"
        >
          <i class="fas fa-search"></i>
        </button>
      </div>
      
      <button 
        id="locationButton"
        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg whitespace-nowrap"
      >
        <i class="fas fa-map-marker-alt mr-2"></i>Minha Localiza√ß√£o
      </button>
    </div>
    
    <div id="status" class="text-center p-4 mb-4 rounded-lg bg-gray-200 dark:bg-gray-700 dark:text-white">
      <i class="fas fa-info-circle mr-2"></i>Digite uma cidade ou use sua localiza√ß√£o
    </div>
    <div id="grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
    
    <div class="border-t-2 border-gray-300 dark:border-gray-600 my-6"></div>
    
    <h2 class="text-xl font-bold mb-4">Pr√≥ximas Horas</h2>
    <div id="forecastGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>

    <!-- RELAT√ìRIO DA APLICA√á√ÉO -->
    <div class="border-t-2 border-gray-300 dark:border-gray-600 my-6"></div>

    <h2 class="text-xl font-bold mb-3">üìë Relat√≥rio da Aplica√ß√£o</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Identifica√ß√£o -->
      <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-3">Identifica√ß√£o</h3>
        <label class="block text-sm mb-1">Nome do Piloto</label>
        <input id="pilotoNome" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: Jo√£o Silva">

        <label class="block text-sm mt-3 mb-1">Modelo do Drone</label>
        <input id="droneModelo" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: EAV 60X">

        <label class="block text-sm mt-3 mb-1">Local da Pulveriza√ß√£o</label>
        <input id="localPulv" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: Fazenda Boa Vista - Talh√£o 3">

        <label class="block text-sm mt-3 mb-1">Data/Hora da Aplica√ß√£o</label>
        <input id="dataHoraAplicacao" type="datetime-local" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600">
      </div>

      <!-- Cultura / Aplica√ß√£o -->
      <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-3">Cultura e Aplica√ß√£o</h3>

        <label class="block text-sm mb-1">Tipo de Cultura</label>
        <select id="cultura" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600"></select>

        <div id="productsContainer">
          <div class="product-section" data-product-id="1">
            <div class="product-header">
              <h4 class="font-semibold">Produto 1</h4>
              <i class="fas fa-trash remove-product hidden" onclick="removeProduct(1)"></i>
            </div>
            <label class="block text-sm mb-1">Tipo de Aplica√ß√£o</label>
            <select class="tipoAplicacao w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="1" onchange="popularProdutosPorTipo(1)"></select>

            <label class="block text-sm mt-3 mb-1">Produto</label>
            <select class="produto w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="1"></select>

            <label class="block text-sm mt-3 mb-1">Dosagem do Produto (mL/ha ou L/ha)</label>
            <input class="dosagemProduto w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="1" type="number" step="0.01" min="0" placeholder="Ex.: 0.5">

            <label class="block text-sm mt-3 mb-1">Adjuvante</label>
            <select class="adjuvante w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="1"></select>

            <label class="block text-sm mt-3 mb-1">Dosagem do Adjuvante (mL/ha ou L/ha)</label>
            <input class="dosagemAdjuvante w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="1" type="number" step="0.01" min="0" placeholder="Ex.: 0.2">
          </div>
        </div>

        <button id="addProduct" class="mt-3 px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2">
          <i class="fas fa-plus"></i> Adicionar Mais Produto
        </button>

        <label class="block text-sm mt-3 mb-1">Quantidade de √Ågua (L/ha)</label>
        <input id="quantidadeAgua" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 10">

        <label class="block text-sm mt-3 mb-1">√Årea Pulverizada (ha)</label>
        <input id="areaPulverizada" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 50">
      </div>

      <!-- Configura√ß√µes do Drone -->
      <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow md:col-span-2">
        <h3 class="font-semibold mb-3">Configura√ß√µes do Drone</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm mb-1">Faixa (m)</label>
            <input id="faixa" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 7.0">
          </div>
          <div>
            <label class="block text-sm mb-1">Velocidade (m/s)</label>
            <input id="velocidade" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 5">
          </div>
          <div>
            <label class="block text-sm mb-1">Altura (m)</label>
            <input id="altura" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 3.0">
          </div>
          <div>
            <label class="block text-sm mb-1">Vaz√£o (L/ha)</label>
            <input id="vazao" type="number" step="0.1" min="0" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Ex.: 12">
          </div>
        </div>

        <label class="block text-sm mt-3 mb-1">Observa√ß√µes</label>
        <textarea id="observacoes" rows="3" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Observa√ß√µes adicionais..."></textarea>
      </div>
    </div>

    <div class="mt-6 text-center">
      <button
        id="downloadReportBottom"
        class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2 mx-auto"
        title="Baixar relat√≥rio com os dados atuais"
      >
        <i class="fas fa-download"></i> Baixar Relat√≥rio
      </button>
    </div>
  </div>

  <!-- Script do Vercel Analytics -->
  <script defer src="https://va.vercel.app/script.js" data-site-id="prj_SkeShTMB77FJI0Be3LjaK9zij71n"></script>
</body>
<script>
  const grid = document.getElementById("grid");
  const forecastGrid = document.getElementById("forecastGrid");
  const statusBox = document.getElementById("status");
  const cityInput = document.getElementById("cityInput");
  const citySuggestions = document.getElementById("citySuggestions");
  const locationButton = document.getElementById("locationButton");
  const themeToggle = document.getElementById("themeToggle");
  const themeIcon = document.getElementById("themeIcon");
  const productsContainer = document.getElementById("productsContainer");
  const addProductButton = document.getElementById("addProduct");
  const visitorCountElement = document.getElementById("visitorCount");
  const visitorNumberElement = document.getElementById("visitorNumber");

  const QTD_PREVISOES = 5;

  // LISTAS
  const CULTURAS = [
    "Cana", "Milho", "Mato", "Soja", "Sorgo", "Algod√£o", "Caf√©", "Feij√£o", 
    "Trigo", "Arroz", "Cevada", "Citrus", "Eucalipto", "Pastagem", "Hortali√ßas"
  ];
  const TIPOS_APLICACAO = ["Fungicida", "Herbicida", "Inseticida", "Fertilizante Foliar", "Dessecante"];
  const PRODUTOS = {
    Fungicida: [
      "Azoxistrobina", "Mancozebe", "Tebuconazol", "Trifloxistrobina", "Difenoconazol", 
      "Pyraclostrobin", "Boscalid", "Captan", "Chlorothalonil", "Cyproconazole", 
      "Flutriafol", "Propiconazole", "Thiophanate-methyl", "Prothioconazole", 
      "Fluxapyroxad", "Benzovindiflupyr", "Metconazole", "Fenpropimorph", 
      "Triadimefon", "Mefentrifluconazole", "Tetraconazole", "Epoxiconazole", 
      "Carbendazim", "Fludioxonil", "Metalaxyl", "Thiophanate", 
      "Azoxystrobin + Cyproconazole", "Pyraclostrobin + Epoxiconazole", 
      "Trifloxystrobin + Prothioconazole", "Folpet", "Iprodione", "Kresoxim-methyl", 
      "Picoxystrobin", "Pyraclostrobin + Boscalid", "Tebuconazole + Trifloxystrobin"
    ],
    Herbicida: [
      "2,4-D", "Atrazina", "Glifosato", "Paraquat", "Dicamba", "Haloxifope", 
      "Mesotrione", "S-Metolachlor", "Pendimethalin", "Cloransulam-methyl", 
      "Imazethapyr", "Clethodim", "Fomesafen", "Flumioxazin", "Saflufenacil", 
      "Sulfentrazone", "Diuron", "Metribuzin", "Bentazon", "Alachlor", 
      "Acetochlor", "Trifluralin", "Clomazone", "Isoxaflutole", "Tembotrione", 
      "Quizalofop", "Fluazifop", "Linuron", "Hexazinone", "Ametrine", 
      "Glyphosate + 2,4-D", "Imazamox", "Imazapic", "Nicosulfuron", 
      "Aminopyralid", "Clopyralid", "Fluroxypyr", "Oxadiazon", "Oxyfluorfen"
    ],
    Inseticida: [
      "Abamectina", "Clorpirif√≥s", "Imidacloprido", "Lambda-cialotrina", 
      "Tiametoxam", "Lufenuron", "Acephate", "Bifenthrin", "Chlorpyrifos", 
      "Cypermethrin", "Deltamethrin", "Emamectin benzoate", "Indoxacarb", 
      "Methomyl", "Profenofos", "Spinosad", "Thiamethoxam", "Carbaryl", 
      "Malathion", "Permethrin", "Fenvalerate", "Esfenvalerate", 
      "Zeta-cypermethrin", "Chlorantraniliprole", "Flubendiamide", 
      "Diflubenzuron", "Tebufenozide", "Methidathion", "Phosmet", 
      "Dimethoate", "Spinetoram", "Fipronil", "Thiacloprid", "Acetamiprid", 
      "Pymetrozine", "Novaluron", "Beta-cyfluthrin", "Imidacloprid + Beta-cyfluthrin"
    ],
    Fertilizante_Foliar: [
      "Nitrato de Pot√°ssio", "Ureia", "Sulfato de Zinco", "Cloreto de Pot√°ssio", 
      "Fosfato Monoam√¥nico", "Fosfato Diam√¥nico", "Sulfato de Mangan√™s", 
      "Sulfato de Cobre", "√Åcido B√≥rico", "Molibdato de S√≥dio", "Quelato de Ferro", 
      "Quelato de Zinco", "Quelato de Mangan√™s", "Amino√°cidos", "Extrato de Algas", 
      "Nitrofosfato", "Sulfato de Magn√©sio", "Cloreto de C√°lcio", "Fosfito de Pot√°ssio", 
      "Sulfato Ferroso"
    ],
    Dessecante: [
      "Paraquat", "Diquat", "Glufosinato de Am√¥nio", "Saflufenacil", 
      "Carfentrazone", "Flumioxazin", "Glyphosate", "Sulfentrazone", 
      "Clethodim", "2,4-D"
    ]
  };
  const ADJUVANTES = [
    "√ìleo mineral", "√ìleo vegetal", "Espalhante adesivo", "Redutor de deriva", 
    "Condicionador de calda", "Silicone", "Surfactante n√£o i√¥nico", 
    "Surfactante cati√¥nico", "Emulsionante", "Dispersante", "Antiespumante"
  ];

  // Inicializar contador de visitantes
  function inicializarContadorVisitantes() {
    try {
      // Verificar se o script do Vercel Analytics foi carregado
      if (typeof window.va !== 'undefined') {
        // Simular contador de visitantes (em produ√ß√£o, voc√™ usaria a API do Vercel)
        let visitCount = localStorage.getItem('visitCount') || 0;
        visitCount = parseInt(visitCount) + 1;
        localStorage.setItem('visitCount', visitCount);
        
        // Atualizar a interface
        visitorNumberElement.textContent = visitCount;
        visitorCountElement.classList.remove('hidden');
        
        console.log('Contador de visitantes inicializado:', visitCount);
      } else {
        console.warn('Script do Vercel Analytics n√£o carregado');
        // Tentar novamente ap√≥s um tempo
        setTimeout(inicializarContadorVisitantes, 1000);
      }
    } catch (error) {
      console.error('Erro ao inicializar contador de visitantes:', error);
    }
  }

  // HELPERS DE FORM
  function popularSelect(id, opcoes, classe = '') {
    const sel = classe ? document.querySelector(`.${classe}[data-product-id="${id}"]`) : document.getElementById(id);
    if (!sel) {
      console.error(`Elemento n√£o encontrado: ${classe || id}, productId: ${id}`);
      return;
    }
    sel.innerHTML = '<option value="">Selecione...</option>' +
      opcoes.map(o => `<option value="${o}">${o}</option>`).join("");
    console.log(`Dropdown ${classe || id} preenchido com ${opcoes.length} op√ß√µes`);
  }

  function popularProdutosPorTipo(productId) {
    console.log(`Tentando popular produtos para productId: ${productId}`);
    const tipoElement = document.querySelector(`.tipoAplicacao[data-product-id="${productId}"]`);
    if (!tipoElement) {
      console.error(`Elemento .tipoAplicacao[data-product-id="${productId}"] n√£o encontrado`);
      return;
    }
    const tipo = tipoElement.value;
    console.log(`Tipo selecionado: ${tipo}`);
    const lista = tipo && PRODUTOS[tipo.replace(" ", "_")] ? PRODUTOS[tipo.replace(" ", "_")] : [];
    console.log(`Lista de produtos: ${lista.join(", ")}`);
    popularSelect(productId, lista, 'produto');
    if (lista.length === 0) {
      console.warn(`Nenhuma lista de produtos encontrada para o tipo: ${tipo}`);
    }
  }

  function addProduct() {
    const productCount = productsContainer.querySelectorAll('.product-section').length + 1;
    if (productCount > 5) {
      mostrarStatus("Limite m√°ximo de 5 produtos atingido", "warning");
      return;
    }

    console.log(`Adicionando produto ${productCount}`);
    const productSection = document.createElement("div");
    productSection.className = "product-section";
    productSection.dataset.productId = productCount;
    productSection.innerHTML = `
      <div class="product-header">
        <h4 class="font-semibold">Produto ${productCount}</h4>
        <i class="fas fa-trash remove-product" onclick="removeProduct(${productCount})"></i>
      </div>
      <label class="block text-sm mb-1">Tipo de Aplica√ß√£o</label>
      <select class="tipoAplicacao w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="${productCount}" onchange="popularProdutosPorTipo(${productCount})"></select>

      <label class="block text-sm mt-3 mb-1">Produto</label>
      <select class="produto w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="${productCount}"></select>

      <label class="block text-sm mt-3 mb-1">Dosagem do Produto (mL/ha ou L/ha)</label>
      <input class="dosagemProduto w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="${productCount}" type="number" step="0.01" min="0" placeholder="Ex.: 0.5">

      <label class="block text-sm mt-3 mb-1">Adjuvante</label>
      <select class="adjuvante w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="${productCount}"></select>

      <label class="block text-sm mt-3 mb-1">Dosagem do Adjuvante (mL/ha ou L/ha)</label>
      <input class="dosagemAdjuvante w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" data-product-id="${productCount}" type="number" step="0.01" min="0" placeholder="Ex.: 0.2">
    `;
    productsContainer.appendChild(productSection);
    popularSelect(productCount, TIPOS_APLICACAO, 'tipoAplicacao');
    popularSelect(productCount, [], 'produto');
    popularSelect(productCount, ADJUVANTES, 'adjuvante');
  }

  function removeProduct(productId) {
    const productSection = document.querySelector(`.product-section[data-product-id="${productId}"]`);
    if (productId !== 1) {
      console.log(`Removendo produto ${productId}`);
      productSection.remove();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM carregado, inicializando dropdowns");
    popularSelect("cultura", CULTURAS);
    popularSelect(1, TIPOS_APLICACAO, 'tipoAplicacao');
    popularSelect(1, [], 'produto');
    popularSelect(1, ADJUVANTES, 'adjuvante');
    addProductButton.addEventListener("click", addProduct);
    
    // Inicializar contador de visitantes
    inicializarContadorVisitantes();
  });

  function coletarDadosAplicacao() {
    const get = id => (document.getElementById(id)?.value || "").trim();
    const products = [];
    document.querySelectorAll('.product-section').forEach(section => {
      const id = section.dataset.productId;
      const tipoAplicacao = document.querySelector(`.tipoAplicacao[data-product-id="${id}"]`)?.value || "";
      const produto = document.querySelector(`.produto[data-product-id="${id}"]`)?.value || "";
      const dosagemProduto = document.querySelector(`.dosagemProduto[data-product-id="${id}"]`)?.value || "";
      const adjuvante = document.querySelector(`.adjuvante[data-product-id="${id}"]`)?.value || "";
      const dosagemAdjuvante = document.querySelector(`.dosagemAdjuvante[data-product-id="${id}"]`)?.value || "";
      products.push({ id, tipoAplicacao, produto, dosagemProduto, adjuvante, dosagemAdjuvante });
    });

    return {
      piloto: get("pilotoNome"),
      droneModelo: get("droneModelo"),
      localPulv: get("localPulv"),
      dataHoraAplicacao: get("dataHoraAplicacao"),
      cultura: get("cultura"),
      products,
      quantidadeAgua: get("quantidadeAgua"),
      areaPulverizada: get("areaPulverizada"),
      faixa: get("faixa"),
      velocidade: get("velocidade"),
      altura: get("altura"),
      vazao: get("vazao"),
      observacoes: get("observacoes")
    };
  }

  function temAplicacaoPreenchida(apl) {
    return Object.values(apl).some(v => (typeof v === 'string' && v.trim() !== "") || (Array.isArray(v) && v.length > 0 && v.some(p => p.tipoAplicacao || p.produto)));
  }

  // TEMA
  const savedTheme = localStorage.getItem('theme') || 
                    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  if (savedTheme === 'dark') {
    document.documentElement.classList.add('dark-mode');
    themeIcon.classList.replace('fa-moon', 'fa-sun');
  }

  themeToggle.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark-mode');
    if (document.documentElement.classList.contains('dark-mode')) {
      themeIcon.classList.replace('fa-moon', 'fa-sun');
      localStorage.setItem('theme', 'dark');
    } else {
      themeIcon.classList.replace('fa-sun', 'fa-moon');
      localStorage.setItem('theme', 'light');
    }
  });

  let ultimaBusca = null;
  let usandoGPS = false;
  let ultimaLocalizacao = null;

  // AUTOCOMPLETAR
  let sugestaoAbortCtrl = null;
  cityInput.addEventListener("input", async function() {
    const termo = this.value.trim();
    citySuggestions.innerHTML = "";
    if (termo.length < 2) {
      citySuggestions.style.display = "none";
      citySuggestions.classList.add("hidden");
      return;
    }

    try {
      if (sugestaoAbortCtrl) sugestaoAbortCtrl.abort();
      sugestaoAbortCtrl = new AbortController();
      const resp = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(termo)}&limit=7&addressdetails=1&accept-language=pt-BR`,
        { signal: sugestaoAbortCtrl.signal, headers: { "Accept": "application/json" } }
      );
      const dados = await resp.json();
      if (!Array.isArray(dados) || dados.length === 0) {
        citySuggestions.style.display = "none";
        citySuggestions.classList.add("hidden");
        return;
      }

      dados.forEach(item => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = item.display_name;
        div.onclick = () => {
          const cidade = item.address.city || item.address.town || item.address.municipality || item.address.county || "Local Desconhecido";
          const bairro = item.address.village || item.address.suburb || item.address.neighbourhood || "";
          cityInput.value = bairro ? `${cidade} - ${bairro}` : cidade;
          citySuggestions.style.display = "none";
          citySuggestions.classList.add("hidden");
          buscarPorCidade();
        };
        citySuggestions.appendChild(div);
      });

      citySuggestions.classList.remove("hidden");
      citySuggestions.style.display = "block";
    } catch (e) {
      citySuggestions.style.display = "none";
      citySuggestions.classList.add("hidden");
    }
  });
  cityInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") buscarPorCidade();
  });

  document.addEventListener("click", function(e) {
    if (!citySuggestions.contains(e.target) && e.target !== cityInput) {
      citySuggestions.style.display = "none";
      citySuggestions.classList.add("hidden");
    }
  });

  function mostrarStatus(mensagem, tipo = 'info') {
    const cores = {
      info: 'bg-gray-200 dark:bg-gray-700',
      success: 'bg-green-400 dark:bg-green-600',
      warning: 'bg-yellow-400 dark:bg-yellow-600',
      error: 'bg-red-400 dark:bg-red-600'
    };
    const icones = {
      info: 'fa-info-circle',
      success: 'fa-check-circle',
      warning: 'fa-exclamation-circle',
      error: 'fa-exclamation-triangle'
    };
    
    statusBox.className = `text-center p-4 mb-4 rounded-lg ${cores[tipo]} dark:text-white`;
    statusBox.innerHTML = `<i class="fas ${icones[tipo]} mr-2"></i>${mensagem}`;
  }

  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  async function obterNomeCidade(lat, lon) {
    const cacheKey = `cidade_${lat.toFixed(4)}_${lon.toFixed(4)}`;
    const cachedCidade = localStorage.getItem(cacheKey);
    if (cachedCidade) return cachedCidade;

    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=pt-BR`);
      const data = await response.json();
      const cidade = data.address.city || data.address.town || data.address.municipality || data.address.county || "Local Desconhecido";
      const bairro = data.address.village || data.address.suburb || data.address.neighbourhood || "";
      const localizacao = bairro ? `${cidade} - ${bairro}` : cidade;
      localStorage.setItem(cacheKey, localizacao);
      return localizacao;
    } catch (error) {
      console.error('Erro ao obter nome da cidade:', error);
      return "Local Desconhecido";
    }
  }

  async function buscarPorCidade() {
    const cidadeInputValue = cityInput.value.trim();
    if (!cidadeInputValue) {
      mostrarStatus('Digite uma cidade para buscar', 'warning');
      return;
    }

    mostrarStatus(`Buscando dados para ${cidadeInputValue}...`, 'info');

    try {
      const coords = await obterCoordenadasCidadeAPI(cidadeInputValue);
      if (coords) {
        const cidadeDetalhada = await obterNomeCidade(coords.lat, coords.lon);
        cityInput.value = cidadeDetalhada;
        await buscarDadosMeteorologicos(coords.lat, coords.lon, cidadeDetalhada);
      } else {
        mostrarStatus('Cidade n√£o encontrada', 'error');
      }
    } catch (error) {
      console.error('Erro ao buscar cidade:', error);
      mostrarStatus('Erro ao buscar dados da cidade', 'error');
    }
  }

  async function obterCoordenadasCidadeAPI(cidade) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade)}&limit=1&addressdetails=1&accept-language=pt-BR`);
      const data = await response.json();
      if (Array.isArray(data) && data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lon: parseFloat(data[0].lon)
        };
      }
      return null;
    } catch (error) {
      console.error('Erro na geocodifica√ß√£o:', error);
      return null;
    }
  }

  const solicitarLocalizacaoDebounced = debounce(async function() {
    mostrarStatus('Obtendo sua localiza√ß√£o...', 'info');
    locationButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';
    locationButton.disabled = true;

    if (!navigator.geolocation) {
      mostrarStatus('Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
      locationButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Minha Localiza√ß√£o';
      locationButton.disabled = false;
      return;
    }

    try {
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          resolve, 
          reject, 
          {
            enableHighAccuracy: false,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      });

      ultimaLocalizacao = {
        lat: position.coords.latitude,
        lon: position.coords.longitude
      };
      
      const localizacao = await obterNomeCidade(position.coords.latitude, position.coords.longitude);
      cityInput.value = localizacao;
      
      await buscarDadosMeteorologicos(position.coords.latitude, position.coords.longitude, localizacao);
    } catch (error) {
      console.error('Erro na geolocaliza√ß√£o:', error);
      mostrarStatus('N√£o foi poss√≠vel obter sua localiza√ß√£o. Verifique as permiss√µes do navegador.', 'error');
    } finally {
      locationButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Minha Localiza√ß√£o';
      locationButton.disabled = false;
    }
  }, 500);

  locationButton.addEventListener('click', solicitarLocalizacaoDebounced);

  function calcularPontoOrvalho(temp, umidade) {
    if (!temp || !umidade || umidade < 0 || umidade > 100) return null;
    const a = 17.27;
    const b = 237.7;
    const alpha = ((a * temp) / (b + temp)) + Math.log(umidade / 100);
    const pontoOrvalho = (b * alpha) / (a - alpha);
    return pontoOrvalho.toFixed(1);
  }

  async function buscarDadosMeteorologicos(lat, lon, localizacao) {
    try {
      const meteoResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,precipitation,weathercode,windspeed_10m,windgusts_10m&timezone=auto`);
      const meteoData = await meteoResponse.json();
      
      if (!meteoData.current_weather || !meteoData.hourly || !meteoData.hourly.relativehumidity_2m) {
        throw new Error('Dados meteorol√≥gicos incompletos');
      }

      localStorage.setItem('ultimosDadosMeteo', JSON.stringify({ meteoData, timestamp: Date.now() }));

      let kpIndex = "N/D";
      fetch(`https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json`)
        .then(res => res.json())
        .then(kpData => {
          if (kpData.length > 1) {
            kpIndex = parseFloat(kpData[kpData.length - 1][1]).toFixed(1);
            atualizarKP(kpIndex);
          }
        })
        .catch(kpError => console.error('Erro ao obter √≠ndice KP:', kpError));
      
      const agora = new Date();
      const horaAtual = agora.getHours();

      const pontoOrvalho = calcularPontoOrvalho(meteoData.current_weather.temperature, meteoData.hourly.relativehumidity_2m[horaAtual]);
      const deltaT = pontoOrvalho !== null ? (meteoData.current_weather.temperature - pontoOrvalho).toFixed(1) : "N/D";
      
      console.log('Temperatura:', meteoData.current_weather.temperature);
      console.log('Umidade Relativa:', meteoData.hourly.relativehumidity_2m[horaAtual]);
      console.log('Ponto de Orvalho:', pontoOrvalho);
      console.log('Delta T:', deltaT);

      const times = meteoData.hourly.time.map(t => new Date(t).getTime());
      const nowMs = Date.now();

      let startIdx = times.findIndex(ms => ms > nowMs);
      if (startIdx === -1) startIdx = times.length;
      startIdx = Math.max(0, startIdx - 1);

      const previsao = meteoData.hourly.time
        .slice(startIdx, startIdx + QTD_PREVISOES)
        .map((time, i) => {
          const idx = startIdx + i;
          const d = new Date(time);
          const pontoOrvalhoPrev = calcularPontoOrvalho(meteoData.hourly.temperature_2m[idx], meteoData.hourly.relativehumidity_2m[idx]);
          const deltaTPrev = pontoOrvalhoPrev !== null ? (meteoData.hourly.temperature_2m[idx] - pontoOrvalhoPrev).toFixed(1) : "N/D";
          return {
            hora: d.getHours(),
            temp: meteoData.hourly.temperature_2m[idx],
            vento: meteoData.hourly.windspeed_10m[idx],
            chuva: meteoData.hourly.precipitation[idx],
            umidade: meteoData.hourly.relativehumidity_2m[idx],
            pontoOrvalho: pontoOrvalhoPrev,
            deltaT: deltaTPrev,
            iconeClima: obterIconeDoWeatherCode(meteoData.hourly.weathercode[idx]),
            condicao: interpretarWeatherCode(meteoData.hourly.weathercode[idx]),
            isAgora: i === 0
          };
        });

      const dados = {
        atual: {
          condicao: interpretarWeatherCode(meteoData.current_weather.weathercode),
          iconeClima: obterIconeDoWeatherCode(meteoData.current_weather.weathercode),
          temp: meteoData.current_weather.temperature,
          umidade: meteoData.hourly.relativehumidity_2m[horaAtual],
          vento: meteoData.current_weather.windspeed,
          rajada: Math.round(meteoData.hourly.windgusts_10m[horaAtual]),
          direcaoVento: direcaoVento(meteoData.current_weather.winddirection),
          chuva: meteoData.hourly.precipitation[horaAtual],
          visibilidade: (meteoData.hourly.visibility?.[horaAtual] / 1000 || 10).toFixed(1),
          pontoOrvalho: pontoOrvalho || "N/D",
          deltaT: deltaT,
          kpIndex: kpIndex,
          atualizado: agora.toLocaleTimeString(),
          localizacao: localizacao
        },
        previsao
      };
      
      exibirDados(dados.atual, dados.previsao);
      ultimaBusca = { lat, lon, cidade: localizacao };
      usandoGPS = !!localizacao;
    } catch (error) {
      console.error('Erro na API meteorol√≥gica:', error);
      const cachedData = localStorage.getItem('ultimosDadosMeteo');
      if (cachedData) {
        const { meteoData, timestamp } = JSON.parse(cachedData);
        if (Date.now() - timestamp < 3600000) {
          console.log('Usando dados em cache');
          mostrarStatus('Usando dados em cache devido a erro na API', 'warning');
          const agora = new Date();
          const horaAtual = agora.getHours();
          const pontoOrvalho = calcularPontoOrvalho(meteoData.current_weather.temperature, meteoData.hourly.relativehumidity_2m[horaAtual]);
          const deltaT = pontoOrvalho !== null ? (meteoData.current_weather.temperature - pontoOrvalho).toFixed(1) : "N/D";
          
          const times = meteoData.hourly.time.map(t => new Date(t).getTime());
          const nowMs = Date.now();
          let startIdx = times.findIndex(ms => ms > nowMs);
          if (startIdx === -1) startIdx = times.length;
          startIdx = Math.max(0, startIdx - 1);

          const previsao = meteoData.hourly.time
            .slice(startIdx, startIdx + QTD_PREVISOES)
            .map((time, i) => {
              const idx = startIdx + i;
              const d = new Date(time);
              const pontoOrvalhoPrev = calcularPontoOrvalho(meteoData.hourly.temperature_2m[idx], meteoData.hourly.relativehumidity_2m[idx]);
              const deltaTPrev = pontoOrvalhoPrev !== null ? (meteoData.hourly.temperature_2m[idx] - pontoOrvalhoPrev).toFixed(1) : "N/D";
              return {
                hora: d.getHours(),
                temp: meteoData.hourly.temperature_2m[idx],
                vento: meteoData.hourly.windspeed_10m[idx],
                chuva: meteoData.hourly.precipitation[idx],
                umidade: meteoData.hourly.relativehumidity_2m[idx],
                pontoOrvalho: pontoOrvalhoPrev,
                deltaT: deltaTPrev,
                iconeClima: obterIconeDoWeatherCode(meteoData.hourly.weathercode[idx]),
                condicao: interpretarWeatherCode(meteoData.hourly.weathercode[idx]),
                isAgora: i === 0
              };
            });

          const dados = {
            atual: {
              condicao: interpretarWeatherCode(meteoData.current_weather.weathercode),
              iconeClima: obterIconeDoWeatherCode(meteoData.current_weather.weathercode),
              temp: meteoData.current_weather.temperature,
              umidade: meteoData.hourly.relativehumidity_2m[horaAtual],
              vento: meteoData.current_weather.windspeed,
              rajada: Math.round(meteoData.hourly.windgusts_10m[horaAtual]),
              direcaoVento: direcaoVento(meteoData.current_weather.winddirection),
              chuva: meteoData.hourly.precipitation[horaAtual],
              visibilidade: (meteoData.hourly.visibility?.[horaAtual] / 1000 || 10).toFixed(1),
              pontoOrvalho: pontoOrvalho || "N/D",
              deltaT: deltaT,
              kpIndex: "N/D",
              atualizado: agora.toLocaleTimeString(),
              localizacao: localizacao
            },
            previsao
          };
          
          exibirDados(dados.atual, dados.previsao);
          ultimaBusca = { lat, lon, cidade: localizacao };
          usandoGPS = !!localizacao;
        } else {
          mostrarStatus('Erro ao buscar dados meteorol√≥gicos', 'error');
        }
      } else {
        mostrarStatus('Erro ao buscar dados meteorol√≥gicos', 'error');
      }
    }
  }

  function atualizarKP(kpIndex) {
    const kpCard = grid.querySelector(':scope > div:nth-child(10)');
    if (kpCard) {
      const kpOk = kpIndex <= 4;
      kpCard.querySelector('div:nth-child(3)').textContent = kpIndex;
      kpCard.querySelector('div:nth-child(4)').textContent = kpOk ? "Normal" : "Tempestade geomagn√©tica";
      kpCard.className = `p-4 rounded-lg flex flex-col items-center text-center dark:text-white ${kpOk ? "bg-green-300 dark:bg-green-700" : "bg-red-300 dark:bg-red-700"}`;
    }
  }

  function interpretarWeatherCode(code) {
    const codes = {
      0: "C√©u limpo",
      1: "Poucas nuvens",
      2: "Parcialmente nublado",
      3: "Nublado",
      45: "Nevoeiro",
      48: "Nevoeiro com geada",
      51: "Chuvisco leve",
      53: "Chuvisco moderado",
      55: "Chuvisco denso",
      56: "Chuvisco congelante leve",
      57: "Chuvisco congelante denso",
      61: "Chuva leve",
      63: "Chuva moderada",
      65: "Chuva forte",
      66: "Chuva congelante leve",
      67: "Chuva congelante forte",
      71: "Queda de neve leve",
      73: "Queda de neve moderada",
      75: "Queda de neve forte",
      77: "Gr√£os de neve",
      80: "Pancadas de chuva leves",
      81: "Pancadas de chuva moderadas",
      82: "Pancadas de chuva violentas",
      85: "Pancadas de neve leves",
      86: "Pancadas de neve pesadas",
      95: "Trovoada",
      96: "Trovoada com chuva leve",
      99: "Trovoada com chuva forte"
    };
    return codes[code] || `C√≥digo ${code}`;
  }

  function obterIconeDoWeatherCode(code) {
    if (code === 0) return 'fa-sun';
    if (code >= 1 && code <= 3) return 'fa-cloud-sun';
    if (code >= 45 && code <= 57) return 'fa-cloud-rain';
    if (code >= 61 && code <= 67) return 'fa-cloud-showers-heavy';
    if (code >= 71 && code <= 77) return 'fa-snowflake';
    if (code >= 80 && code <= 86) return 'fa-cloud-rain';
    if (code >= 95 && code <= 99) return 'fa-bolt';
    return 'fa-cloud';
  }

  function direcaoVento(graus) {
    const direcoes = ['Norte', 'Nordeste', 'Leste', 'Sudeste', 'Sul', 'Sudoeste', 'Oeste', 'Noroeste'];
    return direcoes[Math.round(graus / 45) % 8];
  }

  function exibirDados(dadosAtuais, previsao) {
    grid.innerHTML = "";
    forecastGrid.innerHTML = "";

    const dadosAtuaisOriginais = {...dadosAtuais};
    let dadosExibidosAtualmente = {...dadosAtuais};

    const atualizarDadosPrincipais = (dados) => {
      dadosExibidosAtualmente = {...dados};
      const pontoOrvalho = dados.pontoOrvalho !== "N/D" ? dados.pontoOrvalho : (calcularPontoOrvalho(dados.temp, dados.umidade) || "N/D");
      const deltaT = dados.deltaT !== "N/D" ? dados.deltaT : (dados.temp - pontoOrvalho).toFixed(1) || "N/D";
      
      const kpStatus = dados.kpIndex === "N/D" ? null : parseFloat(dados.kpIndex);
      const kpOk = kpStatus === null ? true : kpStatus <= 4;

      const condicoes = {
        vento: dados.vento <= 15,
        rajada: dados.rajada <= 25,
        chuva: dados.chuva <= 0.2,
        visibilidade: dados.visibilidade >= 5,
        deltaT: deltaT !== "N/D" && deltaT >= 2 && deltaT <= 10,
        umidade: dados.umidade >= 40 && dados.umidade <= 70,
        kp: kpOk
};

      const okCount = Object.values(condicoes).filter(Boolean).length;
      const totalCondicoes = Object.keys(condicoes).length;

      let statusVoo, statusCor, statusIcone;
      if (okCount === totalCondicoes) {
        statusVoo = "‚úÖ BOM PARA VOAR - Condi√ß√µes ideais para pulveriza√ß√£o!";
        statusCor = "bg-green-400 dark:bg-green-600";
        statusIcone = "fa-check-circle";
      } else if (okCount >= Math.floor(totalCondicoes * 0.7)) {
        statusVoo = "üü° FAVOR√ÅVEL - Avalie com cautela";
        statusCor = "bg-yellow-400 dark:bg-yellow-600";
        statusIcone = "fa-exclamation-circle";
      } else if (okCount >= Math.floor(totalCondicoes * 0.4)) {
        statusVoo = "üü† N√ÉO FAVOR√ÅVEL - Ajuste par√¢metros";
        statusCor = "bg-orange-400 dark:bg-orange-600";
        statusIcone = "fa-exclamation-triangle";
      } else {
        statusVoo = "‚ùå RUIM PARA VOAR - Condi√ß√µes desfavor√°veis";
        statusCor = "bg-red-400 dark:bg-red-600";
        statusIcone = "fa-times-circle";
      }

      grid.innerHTML = "";
      const blocosAtuais = [
        { nome: "Condi√ß√£o", valor: dados.condicao, icone: dados.iconeClima, cor: "bg-blue-100 dark:bg-blue-900" },
        { nome: "Temperatura", valor: `${dados.temp}¬∞C`, icone: "fa-temperature-high", cor: corStatus(dados.temp, 10, 30, true) },
        { nome: "Umidade", valor: `${dados.umidade}%`, icone: "fa-tint", cor: corStatus(dados.umidade, 30, 70) },
        { nome: "Ponto de Orvalho", valor: `${pontoOrvalho}¬∞C`, icone: "fa-tint", cor: corStatus(pontoOrvalho, 10, 15) },
        { nome: "Delta T", valor: `${deltaT}¬∞C`, icone: "fa-thermometer-half", cor: deltaT !== "N/D" ? corStatus(deltaT, 2, 10) : "bg-gray-200 dark:bg-gray-700" },
        { nome: "Vento", valor: `${dados.vento} km/h ${dados.direcaoVento}`, icone: "fa-wind", cor: corStatus(dados.vento, 15, 25) },
        { nome: "Rajadas", valor: `${Math.round(dados.rajada)} km/h`, icone: "fa-wind", cor: corStatus(dados.rajada, 25, 35) },
        { nome: "Chuva", valor: `${dados.chuva}mm`, icone: "fa-cloud-rain", cor: corStatus(dados.chuva, 0.5, 2) },
        { nome: "Visibilidade", valor: `${dados.visibilidade} km`, icone: "fa-eye", cor: corStatus(dados.visibilidade, 5, 3, true) },
        { nome: "√çndice KP", valor: dados.kpIndex, icone: "fa-magnet", cor: kpStatus === null ? "bg-gray-200 dark:bg-gray-700" : (kpOk ? "bg-green-300 dark:bg-green-700" : "bg-red-300 dark:bg-red-700") },
        { nome: "Atualizado", valor: dados.atualizado, icone: "fa-clock", cor: "bg-gray-200 dark:bg-gray-700" }
      ];

      blocosAtuais.forEach(b => {
        const div = document.createElement("div");
        div.className = `${b.cor} p-4 rounded-lg flex flex-col items-center text-center dark:text-white`;
        div.innerHTML = `
          <div class="font-bold mb-1">${b.nome}</div>
          <i class="fas ${b.icone} text-xl mb-1"></i>
          <div>${b.valor}</div>
          ${b.nome === "√çndice KP" && dados.kpIndex !== "N/D" ? `<div class="text-xs mt-1">${kpOk ? "Normal" : "Tempestade geomagn√©tica"}</div>` : ''}
        `;
        grid.appendChild(div);
      });

      let statusKP = '';
      if (dados.kpIndex !== "N/D") {
        statusKP = kpOk ? '' : '<br><strong>Aten√ß√£o:</strong> Tempestade geomagn√©tica (KP > 4) pode afetar o GPS';
      }
      
      statusBox.className = `text-center p-4 mb-4 rounded-lg ${statusCor} dark:text-white`;
      statusBox.innerHTML = `<i class="fas ${statusIcone} mr-2"></i>${statusVoo}${statusKP}`;
    };

    atualizarDadosPrincipais(dadosAtuaisOriginais);

    previsao.forEach((p, idx) => {
      const textoHora = idx === 0 ? "Agora" : `${p.hora}h`;
      
      const condicoesHora = {
        vento: p.vento <= 15,
        chuva: p.chuva <= 0.2,
        umidade: p.umidade >= 40 && p.umidade <= 70,
        deltaT: p.deltaT !== "N/D" && p.deltaT >= 2 && p.deltaT <= 10
      };
      
      const okCountHora = Object.values(condicoesHora).filter(Boolean).length;
      let statusCorHora = '';
      
      if (okCountHora === 4) statusCorHora = 'bg-green-100 dark:bg-green-900';
      else if (okCountHora >= 2) statusCorHora = 'bg-yellow-100 dark:bg-yellow-900';
      else statusCorHora = 'bg-red-100 dark:bg-red-900';

      const card = document.createElement("div");
      card.className = `forecast-card ${statusCorHora} p-3 rounded-lg shadow text-center dark:text-white flex flex-col items-center`;
      card.innerHTML = `
        <div class="font-bold mb-1">${textoHora}</div>
        <i class="fas ${p.iconeClima} text-xl my-1"></i>
        <div class="my-1">${p.temp}¬∞C</div>
        <div class="text-xs">Vento: ${p.vento} km/h</div>
        <div class="text-xs">Chuva: ${p.chuva}mm</div>
      `;

      card.addEventListener('click', () => {
        if (idx === 0) {
          atualizarDadosPrincipais(dadosAtuaisOriginais);
        } else {
          const dadosHora = {
            ...p,
            rajada: Math.round(p.vento * 1.5),
            visibilidade: 10,
            direcaoVento: "Vari√°vel",
            atualizado: new Date().toLocaleTimeString(),
            localizacao: dadosAtuaisOriginais.localizacao,
            iconeClima: p.iconeClima,
            condicao: p.condicao,
            kpIndex: dadosAtuaisOriginais.kpIndex
          };
          atualizarDadosPrincipais(dadosHora);
        }
      });

      forecastGrid.appendChild(card);
    });
  }

  function corStatus(valor, min, max, invertido = false) {
    let verde = invertido ? valor >= max : valor <= min;
    let amarelo = invertido ? (valor < max && valor >= min) : (valor > min && valor <= max);
    if (verde) return "bg-green-300 dark:bg-green-700";
    if (amarelo) return "bg-yellow-300 dark:bg-yellow-700";
    return "bg-red-300 dark:bg-red-700";
  }
function coletarDadosAtuaisDoGrid() {
    const cards = grid.querySelectorAll(':scope > div');
    if (!cards.length) {
      console.warn("Nenhum card encontrado no grid");
      return null;
    }

    const dados = {
      localizacao: ultimaBusca?.cidade || cityInput.value || "--",
      condicao: "--",
      temp: "-- ¬∞C",
      umidade: "-- %",
      pontoOrvalho: "-- ¬∞C",
      deltaT: "-- ¬∞C",
      vento: "-- km/h",
      direcaoVento: "",
      rajada: "-- km/h",
      chuva: "-- mm",
      visibilidade: "-- km",
      kpIndex: "--",
      atualizado: new Date().toLocaleTimeString()
    };

    cards.forEach(card => {
      const nomeElement = card.querySelector('.font-bold');
      if (!nomeElement) return;
      
      const nome = nomeElement.textContent.trim();
      const valorElement = card.querySelector('.font-bold ~ div:not(.fa)');
      if (!valorElement) return;
      
      const valor = valorElement.textContent.trim();
      
      switch(nome) {
        case "Condi√ß√£o":
          dados.condicao = valor;
          break;
        case "Temperatura":
          dados.temp = valor.includes("¬∞C") ? valor : valor + " ¬∞C";
          break;
        case "Umidade":
          dados.umidade = valor.includes("%") ? valor : valor + " %";
          break;
        case "Ponto de Orvalho":
          dados.pontoOrvalho = valor.includes("¬∞C") ? valor : valor + " ¬∞C";
          break;
        case "Delta T":
          dados.deltaT = valor.includes("¬∞C") ? valor : valor + " ¬∞C";
          break;
        case "Vento":
          dados.vento = valor.includes("km/h") ? valor.split(" km/h")[0] + " km/h" : valor + " km/h";
          const parts = valor.split(" ");
          if (parts.length > 2) {
            dados.direcaoVento = parts.slice(2).join(" ");
          }
          break;
        case "Rajadas":
          dados.rajada = valor.includes("km/h") ? valor : valor + " km/h";
          break;
        case "Chuva":
          dados.chuva = valor.includes("mm") ? valor : valor + " mm";
          break;
        case "Visibilidade":
          dados.visibilidade = valor.includes("km") ? valor : valor + " km";
          break;
        case "√çndice KP":
          dados.kpIndex = valor;
          break;
        case "Atualizado":
          dados.atualizado = valor;
          break;
      }
    });

    return dados;
  }

  function coletarDadosPrevisaoDoGrid() {
    const cards = forecastGrid.querySelectorAll('.forecast-card');
    if (!cards.length) {
      console.warn("Nenhum card de previs√£o encontrado no forecastGrid");
      return [];
    }

    const previsoes = [];
    cards.forEach((card, idx) => {
      if (idx >= QTD_PREVISOES) return;
      const hora = card.querySelector('.font-bold').textContent.trim();
      const temp = card.querySelector('.my-1').textContent.trim();
      const vento = card.querySelector('.text-xs:nth-child(4)').textContent.replace("Vento: ", "").trim();
      const chuva = card.querySelector('.text-xs:nth-child(5)').textContent.replace("Chuva: ", "").trim();
      previsoes.push({
        hora,
        temp,
        vento,
        chuva
      });
    });

    return previsoes;
  }

  function validarAplicacao(apl) {
    let erros = [];
    apl.products.forEach((p, index) => {
      if (!p.tipoAplicacao) erros.push(`Produto ${index + 1}: Tipo de Aplica√ß√£o √© obrigat√≥rio`);
      if (!p.produto) erros.push(`Produto ${index + 1}: Produto √© obrigat√≥rio`);
      if (p.dosagemProduto && p.dosagemProduto < 0) erros.push(`Produto ${index + 1}: Dosagem do Produto n√£o pode ser negativa`);
      if (p.dosagemAdjuvante && p.dosagemAdjuvante < 0) erros.push(`Produto ${index + 1}: Dosagem do Adjuvante n√£o pode ser negativa`);
    });
    if (apl.quantidadeAgua && apl.quantidadeAgua < 0) erros.push("Quantidade de √Ågua n√£o pode ser negativa");
    if (apl.areaPulverizada && apl.areaPulverizada < 0) erros.push("√Årea Pulverizada n√£o pode ser negativa");
    if (apl.faixa && apl.faixa < 0) erros.push("Faixa n√£o pode ser negativa");
    if (apl.velocidade && apl.velocidade < 0) erros.push("Velocidade n√£o pode ser negativa");
    if (apl.altura && apl.altura < 0) erros.push("Altura n√£o pode ser negativa");
    if (apl.vazao && apl.vazao < 0) erros.push("Vaz√£o n√£o pode ser negativa");
    return erros;
  }

  function gerarRelatorioExcelDeDadosAtuais(dados) {
    try {
      if (!window.XLSX) {
        console.error("Biblioteca XLSX n√£o carregada.");
        mostrarStatus("Erro: Biblioteca de exporta√ß√£o para Excel n√£o carregada.", "error");
        return;
      }

      const apl = coletarDadosAplicacao();
      const incluirAplicacao = temAplicacaoPreenchida(apl);
      
      // Se a aplica√ß√£o n√£o estiver preenchida, apenas validar os dados meteorol√≥gicos
      if (incluirAplicacao) {
        const erros = validarAplicacao(apl);
        if (erros.length > 0) {
          mostrarStatus(`Erro: ${erros.join("; ")}`, "error");
          return;
        }
      }

      // Criar uma √∫nica planilha com todos os dados
      const linhas = [
        ["Relat√≥rio Bom para Voar"],
        ["Gerado em:", new Date().toLocaleString()],
        ["Localiza√ß√£o:", dados.localizacao],
        [],
        ["DADOS METEOROL√ìGICOS ATUAIS"],
        ["Condi√ß√£o", dados.condicao],
        ["Temperatura", dados.temp],
        ["Umidade", dados.umidade],
        ["Ponto de Orvalho", dados.pontoOrvalho],
        ["Delta T", dados.deltaT],
        ["Vento", dados.vento + (dados.direcaoVento ? " " + dados.direcaoVento : "")],
        ["Rajadas", dados.rajada],
        ["Chuva", dados.chuva],
        ["Visibilidade", dados.visibilidade],
        ["√çndice KP", dados.kpIndex],
        ["Atualizado", dados.atualizado],
        []
      ];

      // Adicionar dados de aplica√ß√£o se preenchidos
      if (incluirAplicacao) {
        linhas.push(
          ["RELAT√ìRIO DA APLICA√á√ÉO"],
          ["Piloto", apl.piloto || "-"],
          ["Modelo do Drone", apl.droneModelo || "-"],
          ["Local da Pulveriza√ß√£o", apl.localPulv || "-"],
          ["Data/Hora da Aplica√ß√£o", apl.dataHoraAplicacao || "-"],
          ["Cultura", apl.cultura || "-"],
          ["Quantidade de √Ågua (L/ha)", apl.quantidadeAgua || "-"],
          ["√Årea Pulverizada (ha)", apl.areaPulverizada || "-"],
          ["Faixa (m)", apl.faixa || "-"],
          ["Velocidade (m/s)", apl.velocidade || "-"],
          ["Altura (m)", apl.altura || "-"],
          ["Vaz√£o (L/ha)", apl.vazao || "-"],
          ["Observa√ß√µes", apl.observacoes || "-"],
          []
        );

        apl.products.forEach((p, index) => {
          linhas.push(
            [`Produto ${index + 1}`],
            ["Tipo de Aplica√ß√£o", p.tipoAplicacao || "-"],
            ["Produto", p.produto || "-"],
            ["Dosagem do Produto (mL/ha ou L/ha)", p.dosagemProduto || "-"],
            ["Adjuvante", p.adjuvante || "-"],
            ["Dosagem do Adjuvante (mL/ha ou L/ha)", p.dosagemAdjuvante || "-"],
            []
          );
        });
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(linhas);
      ws["!cols"] = [{ wch: 28 }, { wch: 40 }];
      
      // Adicionar merges para os t√≠tulos
      const merges = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
        { s: { r: 4, c: 0 }, e: { r: 4, c: 1 } }
      ];
      
      // Adicionar merge para o t√≠tulo da aplica√ß√£o se existir
      if (incluirAplicacao) {
        const aplicacaoIndex = linhas.findIndex(row => row[0] === "RELAT√ìRIO DA APLICA√á√ÉO");
        if (aplicacaoIndex >= 0) {
          merges.push({ s: { r: aplicacaoIndex, c: 0 }, e: { r: aplicacaoIndex, c: 1 } });
        }
        
        // Adicionar merges para os produtos
        apl.products.forEach((_, index) => {
          const produtoIndex = linhas.findIndex(row => row[0] === `Produto ${index + 1}`);
          if (produtoIndex >= 0) {
            merges.push({ s: { r: produtoIndex, c: 0 }, e: { r: produtoIndex, c: 1 } });
          }
        });
      }
      
      ws["!merges"] = merges;
      XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio Bom para Voar");

      XLSX.writeFile(wb, `Relatorio_Bom_para_Voar_${new Date().toISOString().slice(0,10)}.xlsx`);
      mostrarStatus("Relat√≥rio gerado com sucesso!", "success");
    } catch (error) {
      console.error("Erro ao gerar Excel:", error);
      mostrarStatus("Erro ao gerar o relat√≥rio. Tente novamente.", "error");
    }
  }

  function gerarRelatorioCSV(dados) {
    try {
      let csvContent = "data:text/csv;charset=utf-8,";

      // Dados Atuais
      const linhas = [
        ["Relat√≥rio Bom para Voar"],
        ["Gerado em:", new Date().toLocaleString()],
        ["Localiza√ß√£o:", dados.localizacao],
        [],
        ["DADOS METEOROL√ìGICOS ATUAIS"],
        ["Condi√ß√£o", dados.condicao],
        ["Temperatura", dados.temp],
        ["Umidade", dados.umidade],
        ["Ponto de Orvalho", dados.pontoOrvalho],
        ["Delta T", dados.deltaT],
        ["Vento", dados.vento + (dados.direcaoVento ? " " + dados.direcaoVento : "")],
        ["Rajadas", dados.rajada],
        ["Chuva", dados.chuva],
        ["Visibilidade", dados.visibilidade],
        ["√çndice KP", dados.kpIndex],
        ["Atualizado", dados.atualizado],
        []
      ];

      // Aplica√ß√£o
      const apl = coletarDadosAplicacao();
      const incluirAplicacao = temAplicacaoPreenchida(apl);
      if (incluirAplicacao) {
        linhas.push(
          ["RELAT√ìRIO DA APLICA√á√ÉO"],
          ["Piloto", apl.piloto || "-"],
          ["Modelo do Drone", apl.droneModelo || "-"],
          ["Local da Pulveriza√ß√£o", apl.localPulv || "-"],
          ["Data/Hora da Aplica√ß√£o", apl.dataHoraAplicacao || "-"],
          ["Cultura", apl.cultura || "-"],
          ["Quantidade de √Ågua (L/ha)", apl.quantidadeAgua || "-"],
          ["√Årea Pulverizada (ha)", apl.areaPulverizada || "-"],
          ["Faixa (m)", apl.faixa || "-"],
          ["Velocidade (m/s)", apl.velocidade || "-"],
          ["Altura (m)", apl.altura || "-"],
          ["Vaz√£o (L/ha)", apl.vazao || "-"],
          ["Observa√ß√µes", apl.observacoes || "-"],
          []
        );

        apl.products.forEach((p, index) => {
          linhas.push(
            [`Produto ${index + 1}`],
            ["Tipo de Aplica√ß√£o", p.tipoAplicacao || "-"],
            ["Produto", p.produto || "-"],
            ["Dosagem do Produto (mL/ha ou L/ha)", p.dosagemProduto || "-"],
            ["Adjuvante", p.adjuvante || "-"],
            ["Dosagem do Adjuvante (mL/ha ou L/ha)", p.dosagemAdjuvante || "-"],
            []
          );
        });
      }

      csvContent += linhas.map(row => row.join(",")).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `Relatorio_Bom_para_Voar_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      mostrarStatus("Relat√≥rio CSV gerado com sucesso!", "success");
    } catch (error) {
      console.error("Erro ao gerar CSV:", error);
      mostrarStatus("Erro ao gerar o relat√≥rio em CSV. Verifique os dados.", "error");
    }
  }

  document.getElementById('downloadReport').addEventListener('click', () => {
    const dados = coletarDadosAtuaisDoGrid();
    if (!dados) {
      mostrarStatus("Nenhum dado dispon√≠vel para exportar", "error");
      return;
    }
    gerarRelatorioExcelDeDadosAtuais(dados);
  });

  document.getElementById('downloadReportBottom').addEventListener('click', () => {
    const dados = coletarDadosAtuaisDoGrid();
    if (!dados) {
      mostrarStatus("Nenhum dado dispon√≠vel para exportar", "error");
      return;
    }
    gerarRelatorioExcelDeDadosAtuais(dados);
  });
</script>
</html>
