<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bom para Voar - Drone Pulverização</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .search-container { position: relative; display: flex; width: 100%; }
    .search-button { position: absolute; right: 0; top: 0; height: 100%; padding: 0 12px; background: #3B82F6; color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; }
    .search-button:hover { background: #2563EB; }
    #citySuggestions { position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; z-index: 10; display: none; }
    .suggestion-item { padding: 8px 12px; cursor: pointer; }
    .suggestion-item:hover { background-color: #f0f0f0; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">Bom para Voar - Drone Pulverização</h1>
    
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <div class="flex-1 relative">
        <input 
          type="text" id="cityInput" placeholder="Digite a cidade para pulverizar (ex: Bauru, SP)" 
          class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
        <div id="citySuggestions" class="hidden"></div>
        <button onclick="buscarPorCidade()" class="absolute right-0 top-0 h-full px-3 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <button onclick="solicitarLocalizacao()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg whitespace-nowrap" id="locationButton">
        <i class="fas fa-map-marker-alt mr-2"></i>Minha Localização
      </button>
    </div>
    
    <div id="status" class="text-center p-4 mb-4 rounded-lg bg-gray-200">
      <i class="fas fa-info-circle mr-2"></i>Digite uma cidade ou use sua localização
    </div>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="grid"></div>
    
    <div class="border-t-2 border-gray-300 my-6"></div>
    
    <h2 class="text-xl font-bold mb-4">Próximas Horas</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="forecastGrid"></div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const forecastGrid = document.getElementById("forecastGrid");
    const statusBox = document.getElementById("status");
    const cityInput = document.getElementById("cityInput");
    const citySuggestions = document.getElementById("citySuggestions");
    const locationButton = document.getElementById("locationButton");

    let ultimaBusca = null;
    let usandoGPS = false;
    let ultimaLocalizacao = null;
    let ultimoStatusVoo = ""; // NOVO - armazena se está bom, regular ou ruim para voar

    const cidadesDisponiveis = [
      "Assis, SP", "Bauru, SP", "Campinas, SP", "Londrina, PR", 
      "Ribeirão Preto, SP", "São Paulo, SP", "Rio de Janeiro, RJ"
    ];

    cityInput.addEventListener("input", function() {
      const termo = this.value.toLowerCase();
      citySuggestions.innerHTML = "";
      if (termo.length < 2) { citySuggestions.classList.add("hidden"); return; }
      const sugestoes = cidadesDisponiveis.filter(cidade => cidade.toLowerCase().includes(termo));
      if (sugestoes.length === 0) { citySuggestions.classList.add("hidden"); return; }
      sugestoes.forEach(cidade => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = cidade;
        div.onclick = () => { cityInput.value = cidade; citySuggestions.classList.add("hidden"); buscarPorCidade(); };
        citySuggestions.appendChild(div);
      });
      citySuggestions.classList.remove("hidden");
    });

    document.addEventListener("click", e => { if (e.target !== cityInput) citySuggestions.classList.add("hidden"); });

    function mostrarStatus(mensagem, tipo = 'info') {
      const cores = { info: 'bg-gray-200', success: 'bg-green-400', warning: 'bg-yellow-400', error: 'bg-red-400' };
      const icones = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', error: 'fa-exclamation-triangle' };
      statusBox.className = `text-center p-4 mb-4 rounded-lg ${cores[tipo]}`;
      statusBox.innerHTML = `<i class="fas ${icones[tipo]} mr-2"></i>${mensagem}`;
    }

    async function solicitarLocalizacao() {
      mostrarStatus('Obtendo sua localização...', 'info');
      locationButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';
      locationButton.disabled = true;
      if (!navigator.geolocation) {
        mostrarStatus('Geolocalização não suportada pelo navegador', 'error');
        locationButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Minha Localização';
        locationButton.disabled = false;
        return;
      }
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        });
        ultimaLocalizacao = { lat: position.coords.latitude, lon: position.coords.longitude };
        const cidade = await obterNomeCidade(position.coords.latitude, position.coords.longitude);
        cityInput.value = cidade;
        await buscarDadosMeteorologicos(position.coords.latitude, position.coords.longitude, cidade);
        mostrarStatus(`Localização obtida com sucesso - ${ultimoStatusVoo}`, 'success'); // ALTERADO
      } catch (error) {
        console.error('Erro na geolocalização:', error);
        mostrarStatus('Não foi possível obter sua localização. Verifique as permissões do navegador.', 'error');
      } finally {
        locationButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Minha Localização';
        locationButton.disabled = false;
      }
    }

    async function obterNomeCidade(lat, lon) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=pt-BR`);
        const data = await response.json();
        return data.address.city || data.address.town || data.address.village || data.address.municipality || data.address.county || "Sua Localização";
      } catch {
        return "Sua Localização";
      }
    }

    async function buscarPorCidade() {
      const cidade = cityInput.value.trim();
      if (!cidade) { mostrarStatus('Digite uma cidade para buscar', 'warning'); return; }
      mostrarStatus(`Buscando dados para ${cidade}...`, 'info');
      try {
        const cidadeConhecida = cidadesDisponiveis.find(c => c.toLowerCase() === cidade.toLowerCase());
        if (cidadeConhecida) {
          const coordenadas = obterCoordenadasCidade(cidadeConhecida);
          if (coordenadas) { await buscarDadosMeteorologicos(coordenadas.lat, coordenadas.lon, cidadeConhecida); return; }
        }
        const coords = await obterCoordenadasCidadeAPI(cidade);
        if (coords) await buscarDadosMeteorologicos(coords.lat, coords.lon, cidade);
        else mostrarStatus('Cidade não encontrada', 'error');
      } catch {
        mostrarStatus('Erro ao buscar dados da cidade', 'error');
      }
    }

    function obterCoordenadasCidade(cidade) {
      const coordenadas = {
        "Assis, SP": { lat: -22.6619, lon: -50.4119 }, "Bauru, SP": { lat: -22.3145, lon: -49.0584 },
        "Campinas, SP": { lat: -22.9056, lon: -47.0608 }, "Londrina, PR": { lat: -23.3103, lon: -51.1628 },
        "Ribeirão Preto, SP": { lat: -21.1775, lon: -47.8103 }, "São Paulo, SP": { lat: -23.5505, lon: -46.6333 },
        "Rio de Janeiro, RJ": { lat: -22.9068, lon: -43.1729 }
      };
      return coordenadas[cidade];
    }

    async function obterCoordenadasCidadeAPI(cidade) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade)}&limit=1&accept-language=pt-BR`);
        const data = await response.json();
        if (data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        return null;
      } catch { return null; }
    }

    async function buscarDadosMeteorologicos(lat, lon, cidade) {
      try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,precipitation,weathercode,windspeed_10m,windgusts_10m,visibility&timezone=auto`);
        const data = await response.json();
        const agora = new Date();
        const horaAtual = agora.getHours();
        const pontoOrvalho = (data.current_weather.temperature - ((100 - data.hourly.relativehumidity_2m[horaAtual]) / 5)).toFixed(1);
        const dados = {
          atual: {
            condicao: interpretarWeatherCode(data.current_weather.weathercode),
            iconeClima: obterIconeDoWeatherCode(data.current_weather.weathercode),
            temp: data.current_weather.temperature,
            umidade: data.hourly.relativehumidity_2m[horaAtual],
            vento: data.current_weather.windspeed,
            rajada: data.hourly.windgusts_10m[horaAtual],
            direcaoVento: direcaoVento(data.current_weather.winddirection),
            chuva: data.hourly.precipitation[horaAtual],
            visibilidade: (data.hourly.visibility[horaAtual] / 1000).toFixed(1),
            pontoOrvalho: pontoOrvalho,
            deltaT: (data.current_weather.temperature - pontoOrvalho).toFixed(1),
            atualizado: agora.toLocaleTimeString(),
            localizacao: cidade
          },
          previsao: data.hourly.time.slice(0, 10).map((time, i) => ({
            hora: new Date(time).getHours() + 'h',
            temp: data.hourly.temperature_2m[i],
            vento: data.hourly.windspeed_10m[i],
            chuva: data.hourly.precipitation[i],
            iconeClima: obterIconeDoWeatherCode(data.hourly.weathercode[i])
          }))
        };
        exibirDados(dados.atual, dados.previsao);
        ultimaBusca = { lat, lon, cidade };
        usandoGPS = !!cidade;
      } catch {
        mostrarStatus('Erro ao buscar dados meteorológicos', 'error');
      }
    }

    function interpretarWeatherCode(code) {
      const codes = { 0: "Céu limpo", 1: "Poucas nuvens", 2: "Parcialmente nublado", 3: "Nublado", 45: "Nevoeiro", 48: "Nevoeiro com geada", 51: "Chuvisco leve", 53: "Chuvisco moderado", 55: "Chuvisco denso", 56: "Chuvisco congelante leve", 57: "Chuvisco congelante denso", 61: "Chuva leve", 63: "Chuva moderada", 65: "Chuva forte", 66: "Chuva congelante leve", 67: "Chuva congelante forte", 71: "Queda de neve leve", 73: "Queda de neve moderada", 75: "Queda de neve forte", 77: "Grãos de neve", 80: "Pancadas de chuva leves", 81: "Pancadas de chuva moderadas", 82: "Pancadas de chuva violentas", 85: "Pancadas de neve leves", 86: "Pancadas de neve pesadas", 95: "Trovoada", 96: "Trovoada com chuva leve", 99: "Trovoada com chuva forte" };
      return codes[code] || `Código ${code}`;
    }

    function obterIconeDoWeatherCode(code) {
      if (code === 0) return 'fa-sun';
      if (code >= 1 && code <= 3) return 'fa-cloud-sun';
      if (code >= 45 && code <= 57) return 'fa-cloud-rain';
      if (code >= 61 && code <= 67) return 'fa-cloud-showers-heavy';
      if (code >= 71 && code <= 77) return 'fa-snowflake';
      if (code >= 80 && code <= 86) return 'fa-cloud-rain';
      if (code >= 95 && code <= 99) return 'fa-bolt';
      return 'fa-cloud';
    }

    function direcaoVento(graus) {
      const direcoes = ['Norte', 'Nordeste', 'Leste', 'Sudeste', 'Sul', 'Sudoeste', 'Oeste', 'Noroeste'];
      return direcoes[Math.round(graus / 45) % 8];
    }

    function exibirDados(dadosAtuais, previsao) {
      grid.innerHTML = "";
      forecastGrid.innerHTML = "";
      const pontoOrvalho = dadosAtuais.pontoOrvalho || (dadosAtuais.temp - ((100 - dadosAtuais.umidade) / 5)).toFixed(1);
      const deltaT = dadosAtuais.deltaT || (dadosAtuais.temp - pontoOrvalho).toFixed(1);
      const condicoes = {
        vento: dadosAtuais.vento <= 15,
        rajada: dadosAtuais.rajada <= 25,
        chuva: dadosAtuais.chuva <= 0.2,
        visibilidade: dadosAtuais.visibilidade >= 5,
        deltaT: deltaT >= 2 && deltaT <= 8,
        umidade: dadosAtuais.umidade >= 40 && dadosAtuais.umidade <= 70
      };
      const todasOk = Object.values(condicoes).every(c => c);
      const algumasOk = Object.values(condicoes).filter(c => c).length >= 4;
      let statusVoo, statusCor, statusIcone;
      if (todasOk) { statusVoo = "✅ BOM PARA VOAR - Condições ideais para pulverização!"; statusCor = "bg-green-400"; statusIcone = "fa-check-circle"; }
      else if (algumasOk) { statusVoo = "⚠️ CONDIÇÕES REGULARES - Avalie com cautela"; statusCor = "bg-yellow-400"; statusIcone = "fa-exclamation-circle"; }
      else { statusVoo = "❌ RUIM PARA VOAR - Condições desfavoráveis"; statusCor = "bg-red-400"; statusIcone = "fa-times-circle"; }
      
      ultimoStatusVoo = statusVoo; // NOVO - guarda status para usar no "Localização obtida com sucesso"

      const blocosAtuais = [
        { nome: "Condição", valor: dadosAtuais.condicao, icone: dadosAtuais.iconeClima, cor: "bg-blue-100" },
        { nome: "Temperatura", valor: `${dadosAtuais.temp}°C`, icone: "fa-temperature-high", cor: corStatus(dadosAtuais.temp, 10, 30, true) },
        { nome: "Umidade", valor: `${dadosAtuais.umidade}%`, icone: "fa-tint", cor: corStatus(dadosAtuais.umidade, 30, 70) },
        { nome: "Ponto de Orvalho", valor: `${pontoOrvalho}°C`, icone: "fa-tint", cor: corStatus(pontoOrvalho, 10, 15) },
       
```
